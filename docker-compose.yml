services:
  claude-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: claude-agent-server
    ports:
      - "${PORT:-8000}:8000"
    environment:
      - PORT=${PORT:-8000}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_AUTH_TOKEN=${ANTHROPIC_AUTH_TOKEN:-}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - ANTHROPIC_DEFAULT_OPUS_MODEL=${ANTHROPIC_DEFAULT_OPUS_MODEL:-}
      - ANTHROPIC_DEFAULT_SONNET_MODEL=${ANTHROPIC_DEFAULT_SONNET_MODEL:-}
      - ANTHROPIC_DEFAULT_HAIKU_MODEL=${ANTHROPIC_DEFAULT_HAIKU_MODEL:-}
    volumes:
      # Mount Claude credentials/config from host
      - ${CLAUDE_CONFIG_PATH:-~/.claude}:/home/claude/.claude:rw
      # Mount workspace for file operations
      - ${WORKSPACE_PATH:-./workspace}:/workspace:rw
    working_dir: /app
    restart: unless-stopped

    # Required for Claude CLI subprocess
    stdin_open: true
    tty: true

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Optional: Create workspace network for isolation
networks:
  default:
    name: claude-network
    driver: bridge