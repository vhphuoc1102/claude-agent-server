version: '3.8'

services:
  claude-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: claude-agent-server
    ports:
      - "${PORT:-8000}:8000"
    environment:
      - PORT=${PORT:-8000}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_AUTH_TOKEN=${ANTHROPIC_AUTH_TOKEN:-}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - ANTHROPIC_DEFAULT_OPUS_MODEL=${ANTHROPIC_DEFAULT_OPUS_MODEL:-}
      - ANTHROPIC_DEFAULT_SONNET_MODEL=${ANTHROPIC_DEFAULT_SONNET_MODEL:-}
      - ANTHROPIC_DEFAULT_HAIKU_MODEL=${ANTHROPIC_DEFAULT_HAIKU_MODEL:-}
    volumes:
      # Mount Claude credentials/config from host
      - ${CLAUDE_CONFIG_PATH:-~/.claude}:/home/claude/.claude:rw
      # Mount workspace for file operations
      - ${WORKSPACE_PATH:-./workspace}:/workspace:rw
    working_dir: /app
    restart: unless-stopped

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true

    # Temporary filesystems for runtime needs
    tmpfs:
      - /tmp:mode=1777,size=256m
      - /home/claude/.cache:mode=0755,size=512m
      - /home/claude/.npm:mode=0755,size=256m

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'
      restart_policy:
        condition: unless-stopped
        delay: 5s
        max_attempts: 3

    # Process limits
    pids_limit: 100

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Optional: Create workspace network for isolation
networks:
  default:
    name: claude-network
    driver: bridge
